<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"><title>Custom Transforms – Lightning CSS</title><link rel="icon" href="rust-less/favicon.3aabf677.svg"><link rel="mask-icon" href="rust-less/favicon.3aabf677.svg" color="#f9bb03"><meta name="description" content="An extremely fast CSS parser, transformer, bundler, and minifier."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="rust-less/og.jpeg"><meta name="twitter:site" content="@lightningcss"><meta name="twitter:creator" content="@lightningcss"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://lightningcss.dev/transforms.html"><meta property="og:title" content="Custom Transforms – Lightning CSS"><meta property="og:description" content="An extremely fast CSS parser, transformer, bundler, and minifier."><meta property="og:image" content="rust-less/og.jpeg"><link rel="stylesheet" href="rust-less/bundling.523e9a32.css"></head><body> <header> <svg viewBox="495 168 360 654"><path class="outer" d="M594.41 805c-.71 0-1.43-.15-2.11-.47a5.015 5.015 0 0 1-2.72-5.83l67.98-253.71H517.11a5.03 5.03 0 0 1-4.44-2.69c-.86-1.65-.73-3.65.34-5.18l26.85-38.35q25.56-36.51 104.91-149.83l106.31-151.82a4.991 4.991 0 0 1 6.21-1.66 5.015 5.015 0 0 1 2.72 5.83L692.03 455h140.45c1.86 0 3.57 1.04 4.43 2.69.86 1.65.73 3.65-.34 5.18l-238.07 340a5.006 5.006 0 0 1-4.1 2.13Zm-67.69-270h137.37c1.55 0 3.02.72 3.97 1.96.95 1.23 1.27 2.84.86 4.34l-62.33 232.61 216.29-308.9H685.52c-1.55 0-3.02-.72-3.97-1.96a4.966 4.966 0 0 1-.86-4.34l62.33-232.61-90.04 128.59q-79.35 113.32-104.91 149.83L526.73 535Z"/><path class="inner" d="M594.41 805c-.71 0-1.43-.15-2.11-.47a5.015 5.015 0 0 1-2.72-5.83l67.98-253.71H517.11a5.03 5.03 0 0 1-4.44-2.69c-.86-1.65-.73-3.65.34-5.18l26.85-38.35q25.56-36.51 104.91-149.83l106.31-151.82a4.991 4.991 0 0 1 6.21-1.66 5.015 5.015 0 0 1 2.72 5.83L692.03 455h140.45c1.86 0 3.57 1.04 4.43 2.69.86 1.65.73 3.65-.34 5.18l-238.07 340a5.006 5.006 0 0 1-4.1 2.13Zm-67.69-270h137.37c1.55 0 3.02.72 3.97 1.96.95 1.23 1.27 2.84.86 4.34l-62.33 232.61 216.29-308.9H685.52c-1.55 0-3.02-.72-3.97-1.96a4.966 4.966 0 0 1-.86-4.34l62.33-232.61-90.04 128.59q-79.35 113.32-104.91 149.83L526.73 535Z"/></svg> <a href="/" class="title">Lightning CSS</a> <p><a href="rust-less/playground/index.html">Playground</a> • <a href="rust-less/docs.html">Docs</a> • <a href="https://docs.rs/lightningcss" target="_blank">Rust docs</a> • <a href="https://npmjs.com/lightningcss" target="_blank">npm</a> • <a href="https://github.com/parcel-bundler/lightningcss" target="_blank">GitHub</a></p> </header> <nav> <h3>Docs</h3> <ul> <li><a href="rust-less/docs.html">Getting started</a></li> <li><a href="rust-less/transpilation.html">Transpilation</a></li> <li><a href="rust-less/css-modules.html">CSS Modules</a></li> <li><a href="rust-less/bundling.html">Bundling</a></li> <li><a href="rust-less/minification.html">Minification</a></li> <li><a href="rust-less/transforms.html">Custom transforms</a></li> <script>document.querySelector(`nav a[href="${location.pathname}"]`).setAttribute("aria-current","page");</script> </ul> </nav> <main> <aside> <p></p><div class="table-of-contents"><h3>On this page</h3><ul><li><a href="#visitors">Visitors</a></li><li><a href="#value-types">Value types</a></li><li><a href="#raw-values">Raw values</a></li><li><a href="#entry-and-exit-visitors">Entry and exit visitors</a></li><li><a href="#composing-visitors">Composing visitors</a></li><li><a href="#unknown-at-rules">Unknown at-rules</a></li><li><a href="#custom-at-rules">Custom at-rules</a></li><li><a href="#examples">Examples</a></li><li><a href="#publishing-a-plugin">Publishing a plugin</a></li><li><a href="#using-plugins">Using plugins</a></li></ul></div><p></p> </aside> <h1 id="custom-transforms" tabindex="-1">Custom transforms</h1> <p>The Lightning CSS visitor API can be used to implement custom transform plugins in JavaScript. It is designed to enable custom non-standard extensions to CSS, making your code easier to author while shipping standard CSS to the browser. You can implement extensions such as custom shorthand properties or additional at-rules (e.g. mixins), build time transforms (e.g. convert units, inline constants, etc.), CSS rule analysis, and much more.</p> <p>Custom transforms have a build time cost: it can be around 2x slower to compile with a JS visitor than without. This means visitors should generally be used to implement custom, non-standard CSS extensions. Common standard transforms such as compiling modern standard CSS features (and draft specs) for older browsers should be done in Rust as part of Lightning CSS itself. Please open an issue if there's a feature we don't handle yet.</p> <h2 id="visitors" tabindex="-1">Visitors</h2> <p>Custom transforms are implemented by passing a <code>visitor</code> object to the Lightning CSS Node API. A visitor includes one or more functions which are called for specific value types such as <code>Rule</code>, <code>Property</code>, or <code>Length</code>. In general, you should try to be as specific as possible about the types of values you want to handle. This way, Lightning CSS needs to call into JS as infrequently as possible, with the smallest objects possible, which improves performance. See the <a href="https://github.com/parcel-bundler/lightningcss/blob/master/node/index.d.ts#L101-L129">TypeScript definitions</a> for a full list of available visitor functions.</p> <p>Visitors can return a new value to update it. Each visitor accepts a different type of value, and usually expects the same type in return. This example multiplies all lengths by 2:</p> <pre class="language-js"><code class="language-js"><span class="keyword token">import</span> <span class="punctuation token">{</span> transform <span class="punctuation token">}</span> <span class="keyword token">from</span> <span class="string token">'lightningcss'</span><span class="punctuation token">;</span>

<span class="keyword token">let</span> res <span class="operator token">=</span> <span class="function token">transform</span><span class="punctuation token">(</span><span class="punctuation token">{</span>
  <span class="literal-property property token">filename</span><span class="operator token">:</span> <span class="string token">'test.css'</span><span class="punctuation token">,</span>
  <span class="literal-property property token">minify</span><span class="operator token">:</span> <span class="boolean token">true</span><span class="punctuation token">,</span>
  <span class="literal-property property token">code</span><span class="operator token">:</span> Buffer<span class="punctuation token">.</span><span class="function token">from</span><span class="punctuation token">(</span><span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">
    .foo {
      width: 12px;
    }
  </span><span class="string template-punctuation token">`</span></span><span class="punctuation token">)</span><span class="punctuation token">,</span>
  <span class="literal-property property token">visitor</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="function token">Length</span><span class="punctuation token">(</span><span class="parameter token">length</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
      <span class="keyword token">return</span> <span class="punctuation token">{</span>
        <span class="literal-property property token">unit</span><span class="operator token">:</span> length<span class="punctuation token">.</span>unit<span class="punctuation token">,</span>
        <span class="literal-property property token">value</span><span class="operator token">:</span> length<span class="punctuation token">.</span>value <span class="operator token">*</span> <span class="number token">2</span>
      <span class="punctuation token">}</span>
    <span class="punctuation token">}</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>

assert<span class="punctuation token">.</span><span class="function token">equal</span><span class="punctuation token">(</span>res<span class="punctuation token">.</span>code<span class="punctuation token">.</span><span class="function token">toString</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">,</span> <span class="string token">'.foo{width:24px}'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
</code></pre> <p>Some visitor functions accept an array as a return value, enabling you to replace one value with multiple, or remove a value by returning an empty array. You can also provide an object instead of a function to further reduce the number of times a visitor is called. For example, when providing a <code>Property</code> visitor, you can use an object with keys for specific property names. This improves performance by only calling your visitor function when needed.</p> <p>This example adds <code>-webkit-overflow-scrolling: touch</code> before any <code>overflow</code> properties.</p> <pre class="language-js"><code class="language-js"><span class="keyword token">let</span> res <span class="operator token">=</span> <span class="function token">transform</span><span class="punctuation token">(</span><span class="punctuation token">{</span>
  <span class="literal-property property token">filename</span><span class="operator token">:</span> <span class="string token">'test.css'</span><span class="punctuation token">,</span>
  <span class="literal-property property token">minify</span><span class="operator token">:</span> <span class="boolean token">true</span><span class="punctuation token">,</span>
  <span class="literal-property property token">code</span><span class="operator token">:</span> Buffer<span class="punctuation token">.</span><span class="function token">from</span><span class="punctuation token">(</span><span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">
    .foo {
      overflow: auto;
    }
  </span><span class="string template-punctuation token">`</span></span><span class="punctuation token">)</span><span class="punctuation token">,</span>
  <span class="literal-property property token">visitor</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="literal-property property token">Property</span><span class="operator token">:</span> <span class="punctuation token">{</span>
      <span class="function token">overflow</span><span class="punctuation token">(</span><span class="parameter token">property</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
        <span class="keyword token">return</span> <span class="punctuation token">[</span><span class="punctuation token">{</span>
          <span class="literal-property property token">property</span><span class="operator token">:</span> <span class="string token">'custom'</span><span class="punctuation token">,</span>
          <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="punctuation token">{</span>
            <span class="literal-property property token">name</span><span class="operator token">:</span> <span class="string token">'-webkit-overflow-scrolling'</span><span class="punctuation token">,</span>
            <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="punctuation token">[</span><span class="punctuation token">{</span>
              <span class="literal-property property token">type</span><span class="operator token">:</span> <span class="string token">'token'</span><span class="punctuation token">,</span>
              <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="punctuation token">{</span>
                <span class="literal-property property token">type</span><span class="operator token">:</span> <span class="string token">'ident'</span><span class="punctuation token">,</span>
                <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="string token">'touch'</span>
              <span class="punctuation token">}</span>
            <span class="punctuation token">}</span><span class="punctuation token">]</span>
          <span class="punctuation token">}</span>
        <span class="punctuation token">}</span><span class="punctuation token">,</span> property<span class="punctuation token">]</span><span class="punctuation token">;</span>
      <span class="punctuation token">}</span><span class="punctuation token">,</span>
    <span class="punctuation token">}</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>

assert<span class="punctuation token">.</span><span class="function token">equal</span><span class="punctuation token">(</span>res<span class="punctuation token">.</span>code<span class="punctuation token">.</span><span class="function token">toString</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">,</span> <span class="string token">'.foo{-webkit-overflow-scrolling:touch;overflow:auto}'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
</code></pre> <h2 id="value-types" tabindex="-1">Value types</h2> <p>The Lightning CSS AST is very detailed – each CSS property has a specific value type with all parts fully normalized. For example, a shorthand property such as <code>background</code> includes values for all of its sub-properties such as <code>background-color</code>, <code>background-image</code>, <code>background-position</code>, etc. This makes it both easier and faster for custom transforms to correctly handle all value types without reimplementing parsing. See the <a href="https://github.com/parcel-bundler/lightningcss/blob/master/node/ast.d.ts">TypeScript definitions</a> for full documentation of all values.</p> <p>Known property values can be either <em>parsed</em> or <em>unparsed</em>. Parsed values are fully expanded following the CSS specification. Unparsed values could not be parsed according to the grammar, and are stored as raw CSS tokens. This may occur because the value is invalid, or because it included unknown values such as CSS variables. Each property visitor function will need to handle both types of values.</p> <pre class="language-js"><code class="language-js"><span class="function token">transform</span><span class="punctuation token">(</span><span class="punctuation token">{</span>
  <span class="literal-property property token">code</span><span class="operator token">:</span> Buffer<span class="punctuation token">.</span><span class="function token">from</span><span class="punctuation token">(</span><span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">
    .foo { width: 12px }
    .bar { width: var(--w) }
  </span><span class="string template-punctuation token">`</span></span><span class="punctuation token">)</span><span class="punctuation token">,</span>
  <span class="literal-property property token">visitor</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="literal-property property token">Property</span><span class="operator token">:</span> <span class="punctuation token">{</span>
      <span class="function token">width</span><span class="punctuation token">(</span><span class="parameter token">v</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
        <span class="keyword token">if</span> <span class="punctuation token">(</span>v<span class="punctuation token">.</span>property <span class="operator token">===</span> <span class="string token">'unparsed'</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
          <span class="comment token">// Handle unparsed value, e.g. `var(--w)`</span>
        <span class="punctuation token">}</span> <span class="keyword token">else</span> <span class="punctuation token">{</span>
          <span class="comment token">// Handle parsed value, e.g. `12px`</span>
        <span class="punctuation token">}</span>
      <span class="punctuation token">}</span>
    <span class="punctuation token">}</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
</code></pre> <p>Unknown properties, including custom properties, have the property type &quot;custom&quot;. These values are also stored as raw CSS tokens. To visit custom properties, use the <code>custom</code> visitor function, or an object to filter by name. For example, to handle a custom <code>size</code> property and expand it to <code>width</code> and <code>height</code>, the following transform might be used.</p> <pre class="language-js"><code class="language-js"><span class="keyword token">let</span> res <span class="operator token">=</span> <span class="function token">transform</span><span class="punctuation token">(</span><span class="punctuation token">{</span>
  <span class="literal-property property token">minify</span><span class="operator token">:</span> <span class="boolean token">true</span><span class="punctuation token">,</span>
  <span class="literal-property property token">code</span><span class="operator token">:</span> Buffer<span class="punctuation token">.</span><span class="function token">from</span><span class="punctuation token">(</span><span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">
    .foo {
      size: 12px;
    }
  </span><span class="string template-punctuation token">`</span></span><span class="punctuation token">)</span><span class="punctuation token">,</span>
  <span class="literal-property property token">visitor</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="literal-property property token">Property</span><span class="operator token">:</span> <span class="punctuation token">{</span>
      <span class="literal-property property token">custom</span><span class="operator token">:</span> <span class="punctuation token">{</span>
        <span class="function token">size</span><span class="punctuation token">(</span><span class="parameter token">property</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
          <span class="comment token">// Handle the size property when the value is a length.</span>
          <span class="keyword token">if</span> <span class="punctuation token">(</span>property<span class="punctuation token">.</span>value<span class="punctuation token">[</span><span class="number token">0</span><span class="punctuation token">]</span><span class="punctuation token">.</span>type <span class="operator token">===</span> <span class="string token">'length'</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
            <span class="keyword token">let</span> value <span class="operator token">=</span> <span class="punctuation token">{</span>
              <span class="literal-property property token">type</span><span class="operator token">:</span> <span class="string token">'length-percentage'</span><span class="punctuation token">,</span>
              <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="punctuation token">{</span> <span class="literal-property property token">type</span><span class="operator token">:</span> <span class="string token">'dimension'</span><span class="punctuation token">,</span> <span class="literal-property property token">value</span><span class="operator token">:</span> property<span class="punctuation token">.</span>value<span class="punctuation token">[</span><span class="number token">0</span><span class="punctuation token">]</span><span class="punctuation token">.</span>value <span class="punctuation token">}</span>
            <span class="punctuation token">}</span><span class="punctuation token">;</span>

            <span class="keyword token">return</span> <span class="punctuation token">[</span>
              <span class="punctuation token">{</span> <span class="literal-property property token">property</span><span class="operator token">:</span> <span class="string token">'width'</span><span class="punctuation token">,</span> value <span class="punctuation token">}</span><span class="punctuation token">,</span>
              <span class="punctuation token">{</span> <span class="literal-property property token">property</span><span class="operator token">:</span> <span class="string token">'height'</span><span class="punctuation token">,</span> value <span class="punctuation token">}</span>
            <span class="punctuation token">]</span><span class="punctuation token">;</span>
          <span class="punctuation token">}</span>
        <span class="punctuation token">}</span>
      <span class="punctuation token">}</span>
    <span class="punctuation token">}</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>

assert<span class="punctuation token">.</span><span class="function token">equal</span><span class="punctuation token">(</span>res<span class="punctuation token">.</span>code<span class="punctuation token">.</span><span class="function token">toString</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">,</span> <span class="string token">'.foo{width:12px;height:12px}'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
</code></pre> <h2 id="raw-values" tabindex="-1">Raw values</h2> <p>The Lightning CSS AST is very detailed, which is really useful when you need to transform it. However, it can be tedious to construct a full AST from scratch when returning entirely new values from a visitor. That's when raw values come in handy. You can return a <code>raw</code> property containing a string of CSS syntax from visitors that return declarations (i.e. properties) and tokens, and Lightning CSS will parse it for you and put it into the AST.</p> <p>This example implements a custom <code>color</code> function, which returns a raw CSS color value as a string, rather than constructing the whole AST.</p> <pre class="language-js"><code class="language-js"><span class="keyword token">let</span> res <span class="operator token">=</span> <span class="function token">transform</span><span class="punctuation token">(</span><span class="punctuation token">{</span>
  <span class="literal-property property token">minify</span><span class="operator token">:</span> <span class="boolean token">true</span><span class="punctuation token">,</span>
  <span class="literal-property property token">code</span><span class="operator token">:</span> Buffer<span class="punctuation token">.</span><span class="function token">from</span><span class="punctuation token">(</span><span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">
    .foo {
      color: color('red');
    }
  </span><span class="string template-punctuation token">`</span></span><span class="punctuation token">)</span><span class="punctuation token">,</span>
  <span class="literal-property property token">visitor</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="literal-property property token">Function</span><span class="operator token">:</span> <span class="punctuation token">{</span>
      <span class="function token">color</span><span class="punctuation token">(</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
        <span class="keyword token">return</span> <span class="punctuation token">{</span> <span class="literal-property property token">raw</span><span class="operator token">:</span> <span class="string token">'rgb(255, 0, 0)'</span> <span class="punctuation token">}</span><span class="punctuation token">;</span>
      <span class="punctuation token">}</span>
    <span class="punctuation token">}</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>

assert<span class="punctuation token">.</span><span class="function token">equal</span><span class="punctuation token">(</span>res<span class="punctuation token">.</span>code<span class="punctuation token">.</span><span class="function token">toString</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">,</span> <span class="string token">'.foo{color:red}'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
</code></pre> <h2 id="entry-and-exit-visitors" tabindex="-1">Entry and exit visitors</h2> <p>By default, visitors are called when traversing downward through the tree (a pre-order traversal). This means each node is visited before its children. Sometimes it is useful to process a node after its children instead (a post-order traversal). This can be done by using an <code>Exit</code> visitor function, such as <code>FunctionExit</code>.</p> <p>For example, if you had a function visitor to double a length argument, and a visitor to replace an environment variable with a value, you could use an exit visitor to process the function after its arguments.</p> <pre class="language-js"><code class="language-js"><span class="keyword token">let</span> res <span class="operator token">=</span> <span class="function token">transform</span><span class="punctuation token">(</span><span class="punctuation token">{</span>
  <span class="literal-property property token">filename</span><span class="operator token">:</span> <span class="string token">'test.css'</span><span class="punctuation token">,</span>
  <span class="literal-property property token">minify</span><span class="operator token">:</span> <span class="boolean token">true</span><span class="punctuation token">,</span>
  <span class="literal-property property token">code</span><span class="operator token">:</span> Buffer<span class="punctuation token">.</span><span class="function token">from</span><span class="punctuation token">(</span><span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">
    .foo {
      padding: double(env(--branding-padding));
    }
  </span><span class="string template-punctuation token">`</span></span><span class="punctuation token">)</span><span class="punctuation token">,</span>
  <span class="literal-property property token">visitor</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="literal-property property token">FunctionExit</span><span class="operator token">:</span> <span class="punctuation token">{</span>
      <span class="comment token">// This will run after the EnvironmentVariable visitor, below.</span>
      <span class="function token">double</span><span class="punctuation token">(</span><span class="parameter token">f</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
        <span class="keyword token">if</span> <span class="punctuation token">(</span>f<span class="punctuation token">.</span>arguments<span class="punctuation token">[</span><span class="number token">0</span><span class="punctuation token">]</span><span class="punctuation token">.</span>type <span class="operator token">===</span> <span class="string token">'length'</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
          <span class="keyword token">return</span> <span class="punctuation token">{</span>
            <span class="literal-property property token">type</span><span class="operator token">:</span> <span class="string token">'length'</span><span class="punctuation token">,</span>
            <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="punctuation token">{</span>
              <span class="literal-property property token">unit</span><span class="operator token">:</span> f<span class="punctuation token">.</span>arguments<span class="punctuation token">[</span><span class="number token">0</span><span class="punctuation token">]</span><span class="punctuation token">.</span>value<span class="punctuation token">.</span>unit<span class="punctuation token">,</span>
              <span class="literal-property property token">value</span><span class="operator token">:</span> f<span class="punctuation token">.</span>arguments<span class="punctuation token">[</span><span class="number token">0</span><span class="punctuation token">]</span><span class="punctuation token">.</span>value<span class="punctuation token">.</span>value <span class="operator token">*</span> <span class="number token">2</span>
            <span class="punctuation token">}</span>
          <span class="punctuation token">}</span><span class="punctuation token">;</span>
        <span class="punctuation token">}</span>
      <span class="punctuation token">}</span>
    <span class="punctuation token">}</span><span class="punctuation token">,</span>
    <span class="literal-property property token">EnvironmentVariable</span><span class="operator token">:</span> <span class="punctuation token">{</span>
      <span class="comment token">// This will run before the FunctionExit visitor, above.</span>
      <span class="property string-property token">'--branding-padding'</span><span class="operator token">:</span> <span class="punctuation token">(</span><span class="punctuation token">)</span> <span class="operator token">=></span> <span class="punctuation token">(</span><span class="punctuation token">{</span>
        <span class="literal-property property token">type</span><span class="operator token">:</span> <span class="string token">'length'</span><span class="punctuation token">,</span>
        <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="punctuation token">{</span>
          <span class="literal-property property token">unit</span><span class="operator token">:</span> <span class="string token">'px'</span><span class="punctuation token">,</span>
          <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="number token">20</span>
        <span class="punctuation token">}</span>
      <span class="punctuation token">}</span><span class="punctuation token">)</span>
    <span class="punctuation token">}</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>

assert<span class="punctuation token">.</span><span class="function token">equal</span><span class="punctuation token">(</span>res<span class="punctuation token">.</span>code<span class="punctuation token">.</span><span class="function token">toString</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">,</span> <span class="string token">'.foo{padding:40px}'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
</code></pre> <h2 id="composing-visitors" tabindex="-1">Composing visitors</h2> <p>Multiple visitors can be combined into one using the <code>composeVisitors</code> function. This lets you reuse visitors between projects by publishing them as plugins. The AST is visited in a single pass, running the functions from each visitor object as if they were written together.</p> <pre class="language-js"><code class="language-js"><span class="keyword token">import</span> <span class="punctuation token">{</span> transform<span class="punctuation token">,</span> composeVisitors <span class="punctuation token">}</span> <span class="keyword token">from</span> <span class="string token">'lightningcss'</span><span class="punctuation token">;</span>

<span class="keyword token">let</span> environmentVisitor <span class="operator token">=</span> <span class="punctuation token">{</span>
  <span class="literal-property property token">EnvironmentVariable</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="property string-property token">'--branding-padding'</span><span class="operator token">:</span> <span class="punctuation token">(</span><span class="punctuation token">)</span> <span class="operator token">=></span> <span class="punctuation token">(</span><span class="punctuation token">{</span>
      <span class="literal-property property token">type</span><span class="operator token">:</span> <span class="string token">'length'</span><span class="punctuation token">,</span>
      <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="punctuation token">{</span>
        <span class="literal-property property token">unit</span><span class="operator token">:</span> <span class="string token">'px'</span><span class="punctuation token">,</span>
        <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="number token">20</span>
      <span class="punctuation token">}</span>
    <span class="punctuation token">}</span><span class="punctuation token">)</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">;</span>

<span class="keyword token">let</span> doubleFunctionVisitor <span class="operator token">=</span> <span class="punctuation token">{</span>
  <span class="literal-property property token">FunctionExit</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="function token">double</span><span class="punctuation token">(</span><span class="parameter token">f</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
      <span class="keyword token">if</span> <span class="punctuation token">(</span>f<span class="punctuation token">.</span>arguments<span class="punctuation token">[</span><span class="number token">0</span><span class="punctuation token">]</span><span class="punctuation token">.</span>type <span class="operator token">===</span> <span class="string token">'length'</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
        <span class="keyword token">return</span> <span class="punctuation token">{</span>
          <span class="literal-property property token">type</span><span class="operator token">:</span> <span class="string token">'length'</span><span class="punctuation token">,</span>
          <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="punctuation token">{</span>
            <span class="literal-property property token">unit</span><span class="operator token">:</span> f<span class="punctuation token">.</span>arguments<span class="punctuation token">[</span><span class="number token">0</span><span class="punctuation token">]</span><span class="punctuation token">.</span>value<span class="punctuation token">.</span>unit<span class="punctuation token">,</span>
            <span class="literal-property property token">value</span><span class="operator token">:</span> f<span class="punctuation token">.</span>arguments<span class="punctuation token">[</span><span class="number token">0</span><span class="punctuation token">]</span><span class="punctuation token">.</span>value<span class="punctuation token">.</span>value <span class="operator token">*</span> <span class="number token">2</span>
          <span class="punctuation token">}</span>
        <span class="punctuation token">}</span><span class="punctuation token">;</span>
      <span class="punctuation token">}</span>
    <span class="punctuation token">}</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">;</span>

<span class="keyword token">let</span> res <span class="operator token">=</span> <span class="function token">transform</span><span class="punctuation token">(</span><span class="punctuation token">{</span>
  <span class="literal-property property token">filename</span><span class="operator token">:</span> <span class="string token">'test.css'</span><span class="punctuation token">,</span>
  <span class="literal-property property token">minify</span><span class="operator token">:</span> <span class="boolean token">true</span><span class="punctuation token">,</span>
  <span class="literal-property property token">code</span><span class="operator token">:</span> Buffer<span class="punctuation token">.</span><span class="function token">from</span><span class="punctuation token">(</span><span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">
    .foo {
      padding: double(env(--branding-padding));
    }
  </span><span class="string template-punctuation token">`</span></span><span class="punctuation token">)</span><span class="punctuation token">,</span>
  <span class="literal-property property token">visitor</span><span class="operator token">:</span> <span class="function token">composeVisitors</span><span class="punctuation token">(</span><span class="punctuation token">[</span>environmentVisitor<span class="punctuation token">,</span> doubleFunctionVisitor<span class="punctuation token">]</span><span class="punctuation token">)</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>

assert<span class="punctuation token">.</span><span class="function token">equal</span><span class="punctuation token">(</span>res<span class="punctuation token">.</span>code<span class="punctuation token">.</span><span class="function token">toString</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">,</span> <span class="string token">'.foo{padding:40px}'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
</code></pre> <p>Each visitor object has the opportunity to visit every value once. If a visitor returns a new value, that value is visited by the other visitor objects but not again by the original visitor that created it. If other visitors subsequently modify the value, the previous visitors will not revisit the value. This is to avoid infinite loops.</p> <h2 id="unknown-at-rules" tabindex="-1">Unknown at-rules</h2> <p>By default, unknown at-rules are stored in the AST as raw tokens. This allows you to interpret them however you like by writing a custom visitor. The following example allows declaring static variables using named at-rules, and inlines them when an <code>at-keyword</code> token is seen:</p> <pre class="language-js"><code class="language-js"><span class="keyword token">let</span> declared <span class="operator token">=</span> <span class="keyword token">new</span> <span class="class-name token">Map</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
<span class="keyword token">let</span> res <span class="operator token">=</span> <span class="function token">transform</span><span class="punctuation token">(</span><span class="punctuation token">{</span>
  <span class="literal-property property token">filename</span><span class="operator token">:</span> <span class="string token">'test.css'</span><span class="punctuation token">,</span>
  <span class="literal-property property token">minify</span><span class="operator token">:</span> <span class="boolean token">true</span><span class="punctuation token">,</span>
  <span class="literal-property property token">code</span><span class="operator token">:</span> Buffer<span class="punctuation token">.</span><span class="function token">from</span><span class="punctuation token">(</span><span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">
    @blue #056ef0;

    .menu_link {
      background: @blue;
    }
  </span><span class="string template-punctuation token">`</span></span><span class="punctuation token">)</span><span class="punctuation token">,</span>
  <span class="literal-property property token">visitor</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="literal-property property token">Rule</span><span class="operator token">:</span> <span class="punctuation token">{</span>
      <span class="function token">unknown</span><span class="punctuation token">(</span><span class="parameter token">rule</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
        declared<span class="punctuation token">.</span><span class="function token">set</span><span class="punctuation token">(</span>rule<span class="punctuation token">.</span>name<span class="punctuation token">,</span> rule<span class="punctuation token">.</span>prelude<span class="punctuation token">)</span><span class="punctuation token">;</span>
        <span class="keyword token">return</span> <span class="punctuation token">[</span><span class="punctuation token">]</span><span class="punctuation token">;</span>
      <span class="punctuation token">}</span>
    <span class="punctuation token">}</span><span class="punctuation token">,</span>
    <span class="literal-property property token">Token</span><span class="operator token">:</span> <span class="punctuation token">{</span>
      <span class="string token">'at-keyword'</span><span class="punctuation token">(</span>token<span class="punctuation token">)</span> <span class="punctuation token">{</span>
        <span class="keyword token">return</span> declared<span class="punctuation token">.</span><span class="function token">get</span><span class="punctuation token">(</span>token<span class="punctuation token">.</span>value<span class="punctuation token">)</span><span class="punctuation token">;</span>
      <span class="punctuation token">}</span>
    <span class="punctuation token">}</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>

assert<span class="punctuation token">.</span><span class="function token">equal</span><span class="punctuation token">(</span>res<span class="punctuation token">.</span>code<span class="punctuation token">.</span><span class="function token">toString</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">,</span> <span class="string token">'.menu_link{background:#056ef0}'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
</code></pre> <h2 id="custom-at-rules" tabindex="-1">Custom at-rules</h2> <p>Raw tokens as stored in unknown at-rules are fine for simple cases, but in more complex cases, you may wish to interpret a custom at-rule body as a standard CSS declaration list or rule list. However, by default, Lightning CSS does not know how unknown rules should be parsed. You can define their syntax using the <code>customAtRules</code> option.</p> <p>The syntax of the at-rule prelude can be defined with a <a href="https://drafts.css-houdini.org/css-properties-values-api/#syntax-strings">CSS syntax string</a>, which Lightning CSS will interpret and use to validate the input CSS. This uses the same syntax as the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@property">@property</a> rule. The body syntax is defined using one of the following options:</p> <ul> <li><code>&quot;declaration-list&quot;</code> – A list of CSS declarations (property value pairs), as in a style rule or other at-rules like <code>@font-face</code>.</li> <li><code>&quot;rule-list&quot;</code> – A list of nested CSS rules, including style rules and at rules. Directly nested declarations with CSS nesting are not allowed. This matches how rules like <code>@keyframes</code> are parsed.</li> <li><code>&quot;style-block&quot;</code> – A list of CSS declarations and/or nested rules. This matches the behavior of rules like <code>@media</code> and <code>@supports</code> which support directly nested declarations when inside a style rule. Note that the <a href="rust-less/transpilation.html#nesting">nesting</a> and <a href="rust-less/transpilation.html#browser-targets">targets</a> options must be defined for nesting to be compiled.</li> </ul> <p>This example defines two custom at-rules. <code>@mixin</code> defines a reusable style block, supporting both directly nested declarations and nested rules. A visitor function registers the mixin in a map and removes the custom rule. <code>@apply</code> looks up the requested mixin in the map and returns the nested rules, which are inlined into the parent.</p> <pre class="language-js"><code class="language-js"><span class="keyword token">let</span> mixins <span class="operator token">=</span> <span class="keyword token">new</span> <span class="class-name token">Map</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
<span class="keyword token">let</span> res <span class="operator token">=</span> <span class="function token">transform</span><span class="punctuation token">(</span><span class="punctuation token">{</span>
  <span class="literal-property property token">filename</span><span class="operator token">:</span> <span class="string token">'test.css'</span><span class="punctuation token">,</span>
  <span class="literal-property property token">minify</span><span class="operator token">:</span> <span class="boolean token">true</span><span class="punctuation token">,</span>
  <span class="literal-property property token">targets</span><span class="operator token">:</span> <span class="punctuation token">{</span> <span class="literal-property property token">chrome</span><span class="operator token">:</span> <span class="number token">100</span> <span class="operator token">&lt;&lt;</span> <span class="number token">16</span> <span class="punctuation token">}</span><span class="punctuation token">,</span>
  <span class="literal-property property token">code</span><span class="operator token">:</span> Buffer<span class="punctuation token">.</span><span class="function token">from</span><span class="punctuation token">(</span><span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">
    @mixin color {
      color: red;

      &amp;.bar {
        color: yellow;
      }
    }

    .foo {
      @apply color;
    }
  </span><span class="string template-punctuation token">`</span></span><span class="punctuation token">)</span><span class="punctuation token">,</span>
  <span class="literal-property property token">customAtRules</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="literal-property property token">mixin</span><span class="operator token">:</span> <span class="punctuation token">{</span>
      <span class="literal-property property token">prelude</span><span class="operator token">:</span> <span class="string token">'&lt;custom-ident>'</span><span class="punctuation token">,</span>
      <span class="literal-property property token">body</span><span class="operator token">:</span> <span class="string token">'style-block'</span>
    <span class="punctuation token">}</span><span class="punctuation token">,</span>
    <span class="literal-property property token">apply</span><span class="operator token">:</span> <span class="punctuation token">{</span>
      <span class="literal-property property token">prelude</span><span class="operator token">:</span> <span class="string token">'&lt;custom-ident>'</span>
    <span class="punctuation token">}</span>
  <span class="punctuation token">}</span><span class="punctuation token">,</span>
  <span class="literal-property property token">visitor</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="literal-property property token">Rule</span><span class="operator token">:</span> <span class="punctuation token">{</span>
      <span class="literal-property property token">custom</span><span class="operator token">:</span> <span class="punctuation token">{</span>
        <span class="function token">mixin</span><span class="punctuation token">(</span><span class="parameter token">rule</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
          mixins<span class="punctuation token">.</span><span class="function token">set</span><span class="punctuation token">(</span>rule<span class="punctuation token">.</span>prelude<span class="punctuation token">.</span>value<span class="punctuation token">,</span> rule<span class="punctuation token">.</span>body<span class="punctuation token">.</span>value<span class="punctuation token">)</span><span class="punctuation token">;</span>
          <span class="keyword token">return</span> <span class="punctuation token">[</span><span class="punctuation token">]</span><span class="punctuation token">;</span>
        <span class="punctuation token">}</span><span class="punctuation token">,</span>
        <span class="function token">apply</span><span class="punctuation token">(</span><span class="parameter token">rule</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
          <span class="keyword token">return</span> mixins<span class="punctuation token">.</span><span class="function token">get</span><span class="punctuation token">(</span>rule<span class="punctuation token">.</span>prelude<span class="punctuation token">.</span>value<span class="punctuation token">)</span><span class="punctuation token">;</span>
        <span class="punctuation token">}</span>
      <span class="punctuation token">}</span>
    <span class="punctuation token">}</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>

assert<span class="punctuation token">.</span><span class="function token">equal</span><span class="punctuation token">(</span>res<span class="punctuation token">.</span>code<span class="punctuation token">.</span><span class="function token">toString</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">,</span> <span class="string token">'.foo{color:red}.foo.bar{color:#ff0}'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
</code></pre> <h2 id="examples" tabindex="-1">Examples</h2> <p>For examples of visitors that perform a variety of real world tasks, see the Lightning CSS <a href="https://github.com/parcel-bundler/lightningcss/blob/master/node/test/visitor.test.mjs">visitor tests</a>.</p> <h2 id="publishing-a-plugin" tabindex="-1">Publishing a plugin</h2> <p>Visitor plugins can be published to npm in order to share them with others. Plugin packages simply consist of an exported visitor object, which users can compose with other plugins via the <code>composeVisitors</code> function as described above.</p> <pre class="language-js"><code class="language-js"><span class="comment token">// lightningcss-plugin-double-function</span>
<span class="keyword token">export</span> <span class="keyword token">default</span> <span class="punctuation token">{</span>
  <span class="literal-property property token">FunctionExit</span><span class="operator token">:</span> <span class="punctuation token">{</span>
    <span class="function token">double</span><span class="punctuation token">(</span><span class="parameter token">f</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
      <span class="comment token">// ...</span>
    <span class="punctuation token">}</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">;</span>
</code></pre> <p>Plugins can also export a function in order to accept options.</p> <pre class="language-js"><code class="language-js"><span class="comment token">// lightningcss-plugin-env</span>
<span class="keyword token">export</span> <span class="keyword token">default</span> <span class="punctuation token">(</span><span class="parameter token">values</span><span class="punctuation token">)</span> <span class="operator token">=></span> <span class="punctuation token">(</span><span class="punctuation token">{</span>
  <span class="function token">EnvironmentVariable</span><span class="punctuation token">(</span><span class="parameter token">env</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
    <span class="keyword token">return</span> values<span class="punctuation token">[</span>env<span class="punctuation token">.</span>name<span class="punctuation token">]</span><span class="punctuation token">;</span>
  <span class="punctuation token">}</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
</code></pre> <p>Plugin package names should start with <code>lightningcss-plugin-</code> and be descriptive about what they do, e.g. <code>lightningcss-plugin-double-function</code>. In addition, they should include the <code>lightningcss-plugin</code> keyword in their package.json so people can find them on npm.</p> <pre class="language-json"><code class="language-json"><span class="punctuation token">{</span>
  <span class="property token">"name"</span><span class="operator token">:</span> <span class="string token">"lightningcss-plugin-double-function"</span><span class="punctuation token">,</span>
  <span class="property token">"keywords"</span><span class="operator token">:</span> <span class="punctuation token">[</span><span class="string token">"lightningcss-plugin"</span><span class="punctuation token">]</span><span class="punctuation token">,</span>
  <span class="property token">"main"</span><span class="operator token">:</span> <span class="string token">"plugin.mjs"</span>
<span class="punctuation token">}</span>
</code></pre> <h2 id="using-plugins" tabindex="-1">Using plugins</h2> <p>To use a published visitor plugin, install the package from npm, import it, and use the <code>composeVisitors</code> function as described above.</p> <pre class="language-js"><code class="language-js"><span class="keyword token">import</span> <span class="punctuation token">{</span> transform<span class="punctuation token">,</span> composeVisitors <span class="punctuation token">}</span> <span class="keyword token">from</span> <span class="string token">'lightningcss'</span><span class="punctuation token">;</span>
<span class="keyword token">import</span> environmentVisitor <span class="keyword token">from</span> <span class="string token">'lightningcss-plugin-environment'</span><span class="punctuation token">;</span>
<span class="keyword token">import</span> doubleFunctionVisitor <span class="keyword token">from</span> <span class="string token">'lightningcss-plugin-double-function'</span><span class="punctuation token">;</span>

<span class="keyword token">let</span> res <span class="operator token">=</span> <span class="function token">transform</span><span class="punctuation token">(</span><span class="punctuation token">{</span>
  <span class="literal-property property token">filename</span><span class="operator token">:</span> <span class="string token">'test.css'</span><span class="punctuation token">,</span>
  <span class="literal-property property token">minify</span><span class="operator token">:</span> <span class="boolean token">true</span><span class="punctuation token">,</span>
  <span class="literal-property property token">code</span><span class="operator token">:</span> Buffer<span class="punctuation token">.</span><span class="function token">from</span><span class="punctuation token">(</span><span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">
    .foo {
      padding: double(env(--branding-padding));
    }
  </span><span class="string template-punctuation token">`</span></span><span class="punctuation token">)</span><span class="punctuation token">,</span>
  <span class="literal-property property token">visitor</span><span class="operator token">:</span> <span class="function token">composeVisitors</span><span class="punctuation token">(</span><span class="punctuation token">[</span>
    <span class="function token">environmentVisitor</span><span class="punctuation token">(</span><span class="punctuation token">{</span>
      <span class="property string-property token">'--branding-padding'</span><span class="operator token">:</span> <span class="punctuation token">{</span>
        <span class="literal-property property token">type</span><span class="operator token">:</span> <span class="string token">'length'</span><span class="punctuation token">,</span>
        <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="punctuation token">{</span>
          <span class="literal-property property token">unit</span><span class="operator token">:</span> <span class="string token">'px'</span><span class="punctuation token">,</span>
          <span class="literal-property property token">value</span><span class="operator token">:</span> <span class="number token">20</span>
        <span class="punctuation token">}</span>
      <span class="punctuation token">}</span>
    <span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">,</span>
    doubleFunctionVisitor
  <span class="punctuation token">]</span><span class="punctuation token">)</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>

assert<span class="punctuation token">.</span><span class="function token">equal</span><span class="punctuation token">(</span>res<span class="punctuation token">.</span>code<span class="punctuation token">.</span><span class="function token">toString</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">,</span> <span class="string token">'.foo{padding:40px}'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
</code></pre> </main> <footer> Copyright © 2022 Devon Govett and Parcel Contributors. </footer> <script async src="rust-less/bundling.a1401b31.js"></script> </body></html>